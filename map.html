<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Naver Web Map</title>
    <style>
        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }
        #map {
            width: 100%;
            height: 100%;
            position: relative;
        }
    </style>

    <!-- 네이버 지도 JS SDK + Geocoder 서브모듈 -->
    <script src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=daqpt6kqp6&submodules=geocoder"></script>
</head>
<body>

<div id="map"></div>

<script>
    // 지도 생성
    var map = new naver.maps.Map('map', {
        center: new naver.maps.LatLng(37.5665, 126.9780), // 초기 위치 (서울 시청 근처)
        zoom: 16
    });

    // 카메라 이동이 끝났을 때 호출
    naver.maps.Event.addListener(map, 'idle', function () {
        var center = map.getCenter();
        var lat = center.lat();
        var lng = center.lng();

        naver.maps.Service.reverseGeocode(
            {
                coords: center   // 기본 옵션 사용
            },
            function (status, response) {
                if (status !== naver.maps.Service.Status.OK) {
                    if (window.Android && Android.onAddressChanged) {
                        Android.onAddressChanged(lat, lng, "");
                    }
                    return;
                }

                var v2 = response.v2;
                var addrText = "";

                // 1) 도로명 주소가 있으면 그거 우선
                if (v2.address && v2.address.roadAddress) {
                    addrText = v2.address.roadAddress;
                }
                // 2) 도로명이 없으면: region + land.number1/2로 지번 상세 조합
                else if (v2.results && v2.results.length > 0) {
                    var r0 = v2.results[0];
                    var region = r0.region || {};
                    var land   = r0.land   || {};

                    var a1 = region.area1 && region.area1.name ? region.area1.name : "";
                    var a2 = region.area2 && region.area2.name ? region.area2.name : "";
                    var a3 = region.area3 && region.area3.name ? region.area3.name : "";
                    var a4 = region.area4 && region.area4.name ? region.area4.name : "";

                    var dongName = land.name || "";      // 동/리 이름
                    var num1 = land.number1 || "";       // 본번
                    var num2 = land.number2 || "";       // 부번

                    var numPart = "";
                    if (num1) {
                        numPart = num1;
                        if (num2) {
                            numPart += "-" + num2;
                        }
                    }

                    // 서울특별시 종로구 사직동 1-23 이런 형식으로 조합
                    var lastPart = dongName;
                    if (numPart) {
                        lastPart += " " + numPart;
                    }

                    addrText = [a1, a2, a3, lastPart]
                        .filter(function (s) { return s && s.trim().length > 0; })
                        .join(" ");
                }
                // 3) 그래도 없으면: 지번 주소 문자열이라도 사용
                else if (v2.address && v2.address.jibunAddress) {
                    addrText = v2.address.jibunAddress;
                }

                // Android WebView로 전달
                if (window.Android && Android.onAddressChanged) {
                    Android.onAddressChanged(lat, lng, addrText);
                }

                // 디버깅용 콘솔 출력
                console.log("reverseGeocode addr =", addrText, v2);
            }
        );
    });
</script>

</body>
</html>
